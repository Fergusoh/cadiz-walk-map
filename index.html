<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cádiz Old Town Walking Route</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <!-- Leaflet Routing Machine CSS removed as routing is now a simple polyline -->

    <style>
        /* Custom styles for Leaflet map display */
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.5rem; /* Rounded corners for the map */
        }
        /* Ensure the body and main container take up the full viewport */
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', sans-serif;
        }
        /* Custom Marker Styling (using a simple circle) */
        .tour-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            background-color: #EF4444; /* Red color */
            border: 2px solid white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            text-align: center;
            line-height: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
        }
        .sidebar-item:hover {
            background-color: #FEF2F2; /* Light red on hover */
        }
        /* Style for the locate button */
        #locate-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            padding: 0.5rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.2s;
        }
        #locate-button:hover {
            background-color: #FEE2E2;
        }

        /* Style the polyline path */
        .tour-path {
            color: #EF4444; 
            opacity: 0.8; 
            weight: 6;
        }
    </style>
</head>

<body class="bg-gray-100 p-4">
    <div id="app" class="flex flex-col lg:flex-row h-full lg:h-[calc(100vh-2rem)] max-w-7xl mx-auto space-y-4 lg:space-y-0 lg:space-x-4">
        
        <!-- Sidebar for Stops List -->
        <div id="sidebar" class="w-full lg:w-1/3 bg-white shadow-xl rounded-xl p-4 overflow-y-auto order-2 lg:order-1 h-64 lg:h-full">
            <h1 class="text-3xl font-extrabold text-gray-800 border-b pb-2 mb-4">Cádiz Old Town Tour</h1>
            <p class="text-sm text-gray-500 mb-4">19 stops | The route for stops 1-7 is now manually traced along the streets. </p>
            <div id="stops-list" class="space-y-2">
                <!-- Stop items will be injected here -->
            </div>
        </div>

        <!-- Map Container -->
        <div class="w-full lg:w-2/3 shadow-xl rounded-xl order-1 lg:order-2 h-96 lg:h-full relative">
            <div id="map"></div>
            
            <!-- Locate Me Button -->
            <button id="locate-button" aria-label="Locate Me on Map">
                <!-- Lucide Icon for Compass/Target -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-locate">
                    <line x1="2" x2="5" y1="12" y2="12"/><line x1="19" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="5"/><line x1="12" x2="12" y1="19" y2="22"/><circle cx="12" cy="12" r="7"/>
                </svg>
            </button>
            
            <!-- Custom Modal for messages -->
            <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-[2000]">
                <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                    <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
                    <p id="modal-text" class="text-gray-700 mb-4"></p>
                    <button id="modal-close-button" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition">Close</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Load Leaflet JavaScript here (without integrity checks) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Data for all 19 stops
        const stops = [
            { id: 1, name: "Plaza de San Juan de Dios", lat: 36.5303, lng: -6.2927, description: "City hall, fountains, palms — Cádiz’s traditional civic heart and perfect starting point." },
            { id: 2, name: "Arco de la Rosa (Medieval Gate)", lat: 36.5293, lng: -6.2943, description: "One of the original medieval gateways into Cádiz; connects Cathedral square to the old walls." },
            { id: 3, name: "Casa del Obispo (Archaeological Site)", lat: 36.5297, lng: -6.2955, description: "Layers of Roman, Visigothic, and Islamic Cádiz revealed underground beside the Cathedral." },
            { id: 4, name: "Teatro Romano", lat: 36.5317, lng: -6.2925, description: "1st-century BC Roman theatre hidden behind the cathedral. Free entry and surprisingly huge." },
            { id: 5, name: "Cádiz Cathedral (Baroque / Neo-classical)", lat: 36.5294, lng: -6.2952, description: "The “Cathedral of the Americas,” built with New World silver. Tower offers the best views in Cádiz." },
            { id: 6, name: "Barrio del Pópulo (Medieval Quarter)", lat: 36.5314, lng: -6.2934, description: "Oldest neighbourhood in Western Europe. Arches, tight alleyways, medieval atmosphere." },
            { id: 7, name: "Plaza de las Flores", lat: 36.5323, lng: -6.2979, description: "Cádiz’s liveliest square — flower stalls, cafés, and people-watching." },
            { id: 8, name: "Mercado Central (Central Market)", lat: 36.5318, lng: -6.2983, description: "Seafood hall, tapas stalls, fresh produce, vibrant energy." },
            { id: 9, name: "Plaza Mina (19th-Century Garden Square)", lat: 36.5352, lng: -6.2969, description: "Elegant shaded square filled with ficus trees; one of Cádiz’s most atmospheric plazas." },
            { id: 10, name: "Museo de Cádiz", lat: 36.5352, lng: -6.2965, description: "Phoenician sarcophagi, Roman statues, archaeology of ancient Gades, and a fine arts gallery." },
            { id: 11, name: "Torre Tavira (Camera Obscura)", lat: 36.5367, lng: -6.2950, description: "18th-century watchtower with Cádiz’s best panoramic view and a working camera obscura." },
            { id: 12, name: "Plaza del Mentidero", lat: 36.5356, lng: -6.3008, description: "Charming plaza known historically as a meeting place for gossip and debate (“mentidero”)." },
            { id: 13, name: "Oratorio de la Santa Cueva", lat: 36.5336, lng: -6.2953, description: "Quiet chapel with dramatic religious art and paintings attributed to Goya." },
            { id: 14, name: "Gran Teatro Falla", lat: 36.5358, lng: -6.3008, description: "Red-brick Neo-Mudejar theatre — the heart of the Cádiz Carnival and its famous chirigotas." },
            { id: 15, name: "Alameda Apodaca (Seaside Promenade)", lat: 36.5370, lng: -6.2983, description: "Beautiful waterfront walk with tile benches, gardens, lanterns, and huge ficus trees." },
            { id: 16, name: "Parque Genovés", lat: 36.5360, lng: -6.3040, description: "Romantic botanical garden with sculpted trees, lagoon, and cliffside views of the Atlantic." },
            { id: 17, name: "Baluarte de la Candelaria (17th-Century Bastion)", lat: 36.5377, lng: -6.2992, description: "Massive fortress guarding Cádiz from the sea; great lookout towards the bay." },
            { id: 18, name: "Castillo de Santa Catalina", lat: 36.5372, lng: -6.3040, description: "Star-shaped fortress overlooking La Caleta; atmospheric walk over the causeway." },
            { id: 19, name: "La Caleta Beach", lat: 36.5330, lng: -6.3045, description: "Small, sheltered beach with fishing boats and the historic Balneario. Magical at sunset." }
        ];

        // Global map variable
        let map;
        let locationMarker = null;
        let accuracyCircle = null;
        let locateWatchId = null; // To store the ID for position watching
        
        // --- Manual Path Tracing Coordinates ---
        // This array holds the final coordinates for the polyline, including intermediate points 
        // manually collected from an external map to follow the actual streets.
        const detailedCoords = [
            // =========================================================
            // MANUALLY TRACED SEGMENT: STOPS 1 to 7
            // =========================================================
            
            // Stop 1: Plaza de San Juan de Dios (Start)
            [36.5303, -6.2927],
            // Corner of Plaza/Calle Plocia
            [36.5300, -6.2930], 
            // Following Calle Plocia toward the Cathedral
            [36.5298, -6.2935], 
            // Turning onto Calle Pelota/passing Arco de la Rosa
            [36.5293, -6.2943], // Stop 2: Arco de la Rosa
            // Turning towards Casa del Obispo
            [36.5295, -6.2948], 
            // Entering the site area
            [36.5297, -6.2955], // Stop 3: Casa del Obispo
            // Tracing the path north to Teatro Romano
            [36.5303, -6.2945], 
            [36.5310, -6.2935], 
            [36.5317, -6.2925], // Stop 4: Teatro Romano
            // Tracing back south-west to the Cathedral entrance
            [36.5305, -6.2937], 
            [36.5294, -6.2952], // Stop 5: Cádiz Cathedral
            
            // --- Tracing Stop 5 (Cathedral) to Stop 6 (Pópulo) ---
            [36.5298, -6.2942], // Through Pópulo Archway
            [36.5305, -6.2938], // Alleyway corner
            [36.5314, -6.2934], // Stop 6: Barrio del Pópulo
            
            // --- Tracing Stop 6 (Pópulo) to Stop 7 (Plaza de las Flores) ---
            [36.5316, -6.2945], // Calle San Martín
            [36.5319, -6.2958], // Calle San Martín
            [36.5320, -6.2969], // Crossing onto the main street
            [36.5323, -6.2979], // Stop 7: Plaza de las Flores

            // =========================================================
            // STRAIGHT LINE SEGMENT: STOPS 8 to 19 
            // Add manual intermediates here to complete the route tracing!
            // =========================================================
        ];
        
        // Append the coordinates for stops 8 through 19 (indices 7 through 18)
        for (let i = 7; i < stops.length; i++) {
            detailedCoords.push([stops[i].lat, stops[i].lng]);
        }
        // End of path construction


        /**
         * Custom function to display modal messages instead of alert()
         */
        function showMessageModal(title, text) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-text').innerText = text;
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('message-modal').classList.add('flex');
        }

        /**
         * Initializes the Leaflet map centered on the starting point of the tour.
         */
        function initMap() {
            const startCoords = [stops[0].lat, stops[0].lng];

            // 1. Initialize the map
            map = L.map('map', {
                center: startCoords,
                zoom: 16,
                zoomControl: false // We will add a custom one later
            });

            // 2. Add Tile Layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // 3. Add Custom Zoom Control
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // 4. Attach event listener to the Locate button
            document.getElementById('locate-button').addEventListener('click', toggleLocationTracking);
            document.getElementById('modal-close-button').addEventListener('click', () => {
                document.getElementById('message-modal').classList.remove('flex');
                document.getElementById('message-modal').classList.add('hidden');
            });
        }

        // Location functions (onLocationFound, onLocationError, etc. remain the same)
        function onLocationFound(e) {
            const radius = e.coords.accuracy;
            const latlng = [e.coords.latitude, e.coords.longitude];

            if (locationMarker) {
                locationMarker.setLatLng(latlng);
            } else {
                locationMarker = L.circleMarker(latlng, {
                    radius: 8,
                    color: '#1D4ED8',
                    fillColor: '#3B82F6',
                    fillOpacity: 1,
                    stroke: true
                }).addTo(map)
                .bindPopup("You are here (Accuracy: " + Math.round(radius) + " meters)").openPopup();
            }

            if (accuracyCircle) {
                accuracyCircle.setLatLng(latlng);
                accuracyCircle.setRadius(radius);
            } else {
                accuracyCircle = L.circle(latlng, radius, {
                    color: '#3B82F6',
                    fillColor: '#60A5FA',
                    fillOpacity: 0.2,
                    weight: 2,
                    opacity: 0.5
                }).addTo(map);
            }

            if (map.isUserLocating) {
                 map.flyTo(latlng, Math.min(17, map.getZoom()), { duration: 1.5 });
                 map.isUserLocating = false;
            }
        }

        function onLocationError(e) {
            let errorMessage = "Could not retrieve location.";
            if (e.code === 1) {
                errorMessage = "Location access denied. Please allow location services for this page.";
            } else if (e.code === 3) {
                 errorMessage = "Location timeout. Please ensure you have a clear GPS signal.";
            }
            showMessageModal("Location Error", errorMessage);
            console.error(e);
            stopLocationTracking();
        }

        function startLocationTracking() {
            if (!("geolocation" in navigator)) {
                showMessageModal("Location Not Supported", "Geolocation is not supported by your browser.");
                return;
            }
            
            map.isUserLocating = true; 
            
            locateWatchId = navigator.geolocation.watchPosition(onLocationFound, onLocationError, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            });
            
            document.getElementById('locate-button').classList.add('text-red-600', 'font-bold');
            showMessageModal("Location Started", "Tracking your position... your current location will be shown as a blue circle.");
        }
        
        function stopLocationTracking() {
            if (locateWatchId !== null) {
                navigator.geolocation.clearWatch(locateWatchId);
                locateWatchId = null;
            }
            if (locationMarker) {
                map.removeLayer(locationMarker);
                locationMarker = null;
            }
            if (accuracyCircle) {
                map.removeLayer(accuracyCircle);
                accuracyCircle = null;
            }
            document.getElementById('locate-button').classList.remove('text-red-600', 'font-bold');
            showMessageModal("Location Stopped", "Location tracking has been turned off.");
        }

        function toggleLocationTracking() {
            if (locateWatchId === null) {
                startLocationTracking();
            } else {
                stopLocationTracking();
            }
        }


        /**
         * Adds markers, draws the simple polyline line, and populates the sidebar.
         */
        function addStopsToMapAndSidebar() {
            const stopsList = document.getElementById('stops-list');
            // allCoords array replaced by detailedCoords defined above

            stops.forEach(stop => {
                const coords = [stop.lat, stop.lng];
                // Note: The polyline now uses detailedCoords, but the markers use the original stop coordinates.

                // --- 1. Create Custom Marker Icon ---
                const customIcon = L.divIcon({
                    className: 'tour-marker',
                    html: `<div>${stop.id}</div>`,
                    iconSize: [25, 25],
                    iconAnchor: [12.5, 25]
                });

                // --- 2. Create Marker and Add to Map ---
                const marker = L.marker(coords, { 
                    icon: customIcon
                }).addTo(map);

                // --- 3. Add Popup Content ---
                const popupContent = `
                    <div class="font-bold text-red-600 text-lg mb-1">STOP ${stop.id}: ${stop.name}</div>
                    <p class="text-gray-700 text-sm">${stop.description}</p>
                `;
                marker.bindPopup(popupContent, {
                    closeButton: false,
                    offset: L.point(0, -10)
                });
                
                // Add click listener to marker to focus on it
                marker.on('click', () => {
                    handleStopClick(stop.id, marker);
                });


                // --- 4. Create Sidebar Item ---
                const listItem = document.createElement('div');
                listItem.id = `stop-${stop.id}`;
                listItem.className = 'sidebar-item p-3 border border-gray-200 rounded-lg cursor-pointer transition-all hover:border-red-400';
                listItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="tour-marker bg-red-500">${stop.id}</div>
                        <div class="flex-grow">
                            <h3 class="text-base font-semibold text-gray-800">${stop.name}</h3>
                            <p class="text-xs text-gray-500 truncate">${stop.description}</p>
                        </div>
                    </div>
                `;

                // Add click listener to sidebar item
                listItem.addEventListener('click', () => {
                    handleStopClick(stop.id, marker);
                });

                stopsList.appendChild(listItem);
            });


            // --- 5. Draw the MANUAL Polyline connecting all points ---
            L.polyline(detailedCoords, {
                className: 'tour-path' // Uses the style defined in the <style> block
            }).addTo(map);


            // Fit map bounds to encompass all points
            // Use the main stop coordinates for bounding to ensure map is centered correctly on POIs
            const mainStopCoords = stops.map(stop => [stop.lat, stop.lng]);
            const bounds = L.latLngBounds(mainStopCoords);
            map.fitBounds(bounds, { padding: [50, 50] });


            // Helper function to handle clicks (from map marker or sidebar)
            function handleStopClick(id, marker) {
                // Pan map to the marker location
                map.flyTo(marker.getLatLng(), 17, { duration: 1.0 });

                // Open the marker's popup
                marker.openPopup();

                // Highlight the corresponding sidebar item
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.classList.remove('bg-red-100', 'border-red-600');
                });
                const clickedItem = document.getElementById(`stop-${id}`);
                clickedItem.classList.add('bg-red-100', 'border-red-600');

                // Scroll the sidebar to the highlighted item
                clickedItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        /**
         * Implements active polling to ensure Leaflet (L) is fully loaded
         * before attempting to call L.map().
         */
        function checkLeafletReady() {
            // Check only for Leaflet (L)
            if (typeof L !== 'undefined' && L.map) {
                try {
                    initMap();
                    addStopsToMapAndSidebar();
                } catch (error) {
                    console.error("Map initialization failed:", error);
                }
            } else {
                // Poll again in 10ms if L is not ready
                setTimeout(checkLeafletReady, 10);
            }
        }

        // Start the polling once the entire script block is executed
        checkLeafletReady();

    </script>
</body>
</html>
