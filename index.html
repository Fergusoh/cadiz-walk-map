<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cádiz Old Town Walking Route</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        /* Custom styles for Leaflet map display */
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.5rem; /* Rounded corners for the map */
        }
        /* Ensure the body and main container take up the full viewport */
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', sans-serif;
        }
        
        /* Custom Marker Styling (using a simple circle) */
        .tour-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            background-color: #EF4444; /* Default Red color */
            border: 2px solid white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            text-align: center;
            line-height: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
            transition: all 0.2s; /* Added transition for smooth change */
        }

        /* New style for the "Next Stop" marker */
        .next-stop-marker {
            background-color: #10B981 !important; /* Green color */
            border: 3px solid #6EE7B7 !important; /* Brighter border */
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.8) !important; /* Green glow */
            width: 30px; /* Slightly larger */
            height: 30px;
            line-height: 30px;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
        }
        .sidebar-item:hover {
            background-color: #FEF2F2; /* Light red on hover */
        }
        
        /* Style for the control buttons container */
        .map-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            gap: 0.5rem;
        }

        /* Style for individual control buttons */
        .map-control-button {
            padding: 0.5rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.2s;
        }
        .map-control-button:hover {
            background-color: #FEE2E2;
        }
        
        /* Style the polyline path */
        .tour-path {
            color: #EF4444; 
            opacity: 0.8; 
            weight: 6;
        }
        
        /* Ensure the sidebar highlight includes the entire block */
        .sidebar-item.bg-red-100 {
            padding-bottom: 0.75rem; /* Adjust padding when highlighted to account for guidance info */
        }
    </style>
</head>

<body class="bg-gray-100 p-4">
    <div id="app" class="flex flex-col lg:flex-row h-full lg:h-[calc(100vh-2rem)] max-w-7xl mx-auto space-y-4 lg:space-y-0 lg:space-x-4">
        
        <!-- Sidebar for Stops List -->
        <div id="sidebar" class="w-full lg:w-1/3 bg-white shadow-xl rounded-xl p-4 overflow-y-auto order-2 lg:order-1 h-64 lg:h-full">
            <h1 class="text-3xl font-extrabold text-gray-800 border-b pb-2 mb-4">Cádiz Old Town Tour</h1>
            <p class="text-sm text-gray-500 mb-4">19 stops | Start tracking your location for real-time guidance!</p>
            
            <!-- Removed Dynamic Navigation Panel -->
            
            <div id="stops-list" class="space-y-2">
                <!-- Stop items will be injected here. Guidance will be injected into the next stop's item. -->
            </div>
        </div>

        <!-- Map Container -->
        <div class="w-full lg:w-2/3 shadow-xl rounded-xl order-1 lg:order-2 h-96 lg:h-full relative">
            <div id="map"></div>
            
            <!-- Control Buttons Container -->
            <div class="map-controls">
                <!-- Locate Me Button -->
                <button id="locate-button" aria-label="Locate Me on Map" class="map-control-button">
                    <!-- Lucide Icon for Compass/Target -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-locate">
                        <line x1="2" x2="5" y1="12" y2="12"/><line x1="19" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="5"/><line x1="12" x2="12" y1="19" y2="22"/><circle cx="12" cy="12" r="7"/>
                    </svg>
                </button>
            </div>
            
            <!-- Custom Modal for messages -->
            <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-[2000]">
                <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                    <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
                    <p id="modal-text" class="text-gray-700 mb-4"></p>
                    <button id="modal-close-button" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition">Close</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Load Leaflet JavaScript here (without integrity checks) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Data for all 19 stops
        const stops = [
            { id: 1, name: "Plaza de San Juan de Dios", lat: 36.5303, lng: -6.2927, description: "City hall, fountains, palms — Cádiz’s traditional civic heart and perfect starting point." },
            { id: 2, name: "Arco de la Rosa (Medieval Gate)", lat: 36.5293, lng: -6.2943, description: "One of the original medieval gateways into Cádiz; connects Cathedral square to the old walls." },
            { id: 3, name: "Casa del Obispo (Archaeological Site)", lat: 36.5297, lng: -6.2955, description: "Layers of Roman, Visigothic, and Islamic Cádiz revealed underground beside the Cathedral." },
            { id: 4, name: "Teatro Romano", lat: 36.5317, lng: -6.2925, description: "1st-century BC Roman theatre hidden behind the cathedral. Free entry and surprisingly huge." },
            { id: 5, name: "Cádiz Cathedral (Baroque / Neo-classical)", lat: 36.5294, lng: -6.2952, description: "The “Cathedral of the Americas,” built with New World silver. Tower offers the best views in Cádiz." },
            { id: 6, name: "Barrio del Pópulo (Medieval Quarter)", lat: 36.5314, lng: -6.2934, description: "Oldest neighbourhood in Western Europe. Arches, tight alleyways, medieval atmosphere." },
            { id: 7, name: "Plaza de las Flores", lat: 36.5323, lng: -6.2979, description: "Cádiz’s liveliest square — flower stalls, cafés, and people-watching." },
            { id: 8, name: "Mercado Central (Central Market)", lat: 36.5318, lng: -6.2983, description: "Seafood hall, tapas stalls, fresh produce, vibrant energy." },
            { id: 9, name: "Plaza Mina (19th-Century Garden Square)", lat: 36.5352, lng: -6.2969, description: "Elegant shaded square filled with ficus trees; one of Cádiz’s most atmospheric plazas." },
            { id: 10, name: "Museo de Cádiz", lat: 36.5352, lng: -6.2965, description: "Phoenician sarcophagi, Roman statues, archaeology of ancient Gades, and a fine arts gallery." },
            { id: 11, name: "Torre Tavira (Camera Obscura)", lat: 36.5367, lng: -6.2950, description: "18th-century watchtower with Cádiz’s best panoramic view and a working camera obscura." },
            { id: 12, name: "Plaza del Mentidero", lat: 36.5356, lng: -6.3008, description: "Charming plaza known historically as a meeting place for gossip and debate (“mentidero”)." },
            { id: 13, name: "Oratorio de la Santa Cueva", lat: 36.5336, lng: -6.2953, description: "Quiet chapel with dramatic religious art and paintings attributed to Goya." },
            { id: 14, name: "Gran Teatro Falla", lat: 36.5358, lng: -6.3008, description: "Red-brick Neo-Mudejar theatre — the heart of the Cádiz Carnival and its famous chirigotas." },
            { id: 15, name: "Alameda Apodaca (Seaside Promenade)", lat: 36.5370, lng: -6.2983, description: "Beautiful waterfront walk with tile benches, gardens, lanterns, and huge ficus trees." },
            { id: 16, name: "Parque Genovés", lat: 36.5360, lng: -6.3040, description: "Romantic botanical garden with sculpted trees, lagoon, and cliffside views of the Atlantic." },
            { id: 17, name: "Baluarte de la Candelaria (17th-Century Bastion)", lat: 36.5377, lng: -6.2992, description: "Massive fortress guarding Cádiz from the sea; great lookout towards the bay." },
            { id: 18, name: "Castillo de Santa Catalina", lat: 36.5372, lng: -6.3040, description: "Star-shaped fortress overlooking La Caleta; atmospheric walk over the causeway." },
            { id: 19, name: "La Caleta Beach", lat: 36.5330, lng: -6.3045, description: "Small, sheltered beach with fishing boats and the historic Balneario. Magical at sunset." }
        ];

        // Global map variable and state
        let map;
        let locationMarker = null;
        let accuracyCircle = null;
        let locateWatchId = null; 
        // Index of the NEXT stop the user should be heading towards (0-indexed)
        let currentStopIndex = 1; 
        
        // State for managing marker icon changes
        let allMarkers = []; // Array to store all Leaflet marker instances ({ id, marker })
        let highlightedMarker = null; // Stores the currently highlighted Leaflet marker instance
        
        // Custom Icon Options
        const defaultIconOptions = {
            className: 'tour-marker',
            iconSize: [25, 25],
            iconAnchor: [12.5, 25]
        };
        
        // Custom style for the NEXT stop
        const nextStopIconOptions = {
            className: 'tour-marker next-stop-marker', 
            iconSize: [30, 30], 
            iconAnchor: [15, 30] 
        };


        
        // --- Manual Path Tracing Coordinates ---
        const detailedCoords = [
            // =========================================================
            // MANUALLY TRACED SEGMENT: STOPS 1 to 7
            // =========================================================
            [36.5303, -6.2927], // Stop 1: Plaza de San Juan de Dios (Start)
            [36.5300, -6.2930], 
            [36.5298, -6.2935], 
            [36.5293, -6.2943], // Stop 2: Arco de la Rosa
            [36.5295, -6.2948], 
            [36.5297, -6.2955], // Stop 3: Casa del Obispo
            [36.5303, -6.2945], 
            [36.5310, -6.2935], 
            [36.5317, -6.2925], // Stop 4: Teatro Romano
            [36.5305, -6.2937], 
            [36.5294, -6.2952], // Stop 5: Cádiz Cathedral
            
            // --- Tracing Stop 5 (Cathedral) to Stop 6 (Pópulo) ---
            [36.5298, -6.2942], 
            [36.5305, -6.2938], 
            [36.5314, -6.2934], // Stop 6: Barrio del Pópulo
            
            // --- Tracing Stop 6 (Pópulo) to Stop 7 (Plaza de las Flores) ---
            [36.5316, -6.2945], 
            [36.5319, -6.2958], 
            [36.5320, -6.2969], 
            [36.5323, -6.2979], // Stop 7: Plaza de las Flores

            // =========================================================
            // TRACING STOPS 7 to 8 
            // =========================================================
            [36.5321, -6.2982], 
            [36.5318, -6.2983], // Stop 8: Mercado Central
            
            // =========================================================
            // TRACING STOPS 8 to 9 (via 10)
            // =========================================================
            [36.5325, -6.2989], 
            [36.5331, -6.2984], 
            [36.5337, -6.2979], 
            [36.5342, -6.2973], 
            [36.5352, -6.2969], // Stop 9: Plaza Mina
            
            // =========================================================
            // TRACING STOPS 9 to 11 (via 10)
            // =========================================================
            [36.5352, -6.2965], // Stop 10: Museo de Cádiz 
            [36.5355, -6.2958], 
            [36.5361, -6.2954], 
            [36.5367, -6.2950], // Stop 11: Torre Tavira

            // =========================================================
            // TRACING STOPS 11 to 14 (via 12 and 13)
            // =========================================================
            [36.5363, -6.2960], 
            [36.5355, -6.2975], 
            [36.5354, -6.2990], 
            [36.5356, -6.3008], // Stop 12: Plaza del Mentidero
            [36.5340, -6.3000], 
            [36.5336, -6.2953], // Stop 13: Oratorio de la Santa Cueva
            [36.5358, -6.3008], // Stop 14: Gran Teatro Falla

            // =========================================================
            // TRACING STOPS 14 to 19 (Along the sea walls)
            // =========================================================
            [36.5360, -6.3015], 
            [36.5365, -6.3020], 
            [36.5370, -6.2983], // Stop 15: Alameda Apodaca 
            [36.5377, -6.2992], // Stop 17: Baluarte de la Candelaria 
            [36.5360, -6.3040], // Stop 16: Parque Genovés 
            [36.5372, -6.3040], // Stop 18: Castillo de Santa Catalina
            [36.5330, -6.3045]  // Stop 19: La Caleta Beach
        ];
        
        /**
         * Custom function to display modal messages instead of alert()
         */
        function showMessageModal(title, text) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-text').innerText = text;
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('message-modal').classList.add('flex');
        }
        
        /**
         * Changes the icon of the current target marker and reverts the previous one.
         */
        function highlightMapMarker(idToHighlight) {
            // 1. Revert previous highlighted marker if it exists
            if (highlightedMarker) {
                const prevStop = highlightedMarker.id;
                const markerToRevert = allMarkers.find(m => m.id === prevStop)?.marker;
                
                if (markerToRevert) {
                    const defaultIcon = L.divIcon({
                        ...defaultIconOptions,
                        html: `<div>${prevStop}</div>`,
                    });
                    markerToRevert.setIcon(defaultIcon);
                }
                highlightedMarker = null;
            }

            // 2. Highlight the new marker if an ID is provided
            if (idToHighlight) {
                const newMarkerData = allMarkers.find(m => m.id === idToHighlight);
                
                if (newMarkerData) {
                    const newIcon = L.divIcon({
                        ...nextStopIconOptions,
                        html: `<div>${idToHighlight}</div>`,
                    });
                    newMarkerData.marker.setIcon(newIcon);
                    highlightedMarker = newMarkerData;
                }
            }
        }
        
        /**
         * Updates the guidance information (distance) directly within the target sidebar item.
         * This replaces the old dedicated navigation panel.
         */
        function updateGuidanceInSidebar(userLat, userLng) {
            
            // 1. Clear all previous guidance information from all items
            document.querySelectorAll('.guidance-info').forEach(el => el.remove());
            
            // If tracking is off, or stops are complete, exit here
            if (locateWatchId === null) return;
            

            // 2. Check for Tour Completion
            if (currentStopIndex >= stops.length) {
                const lastStop = stops[stops.length - 1];
                const lastItem = document.getElementById(`stop-${lastStop.id}`);
                
                if (lastItem) {
                     // Add completion message to the final stop item
                     const completeMsg = document.createElement('div');
                     completeMsg.className = 'guidance-info pt-1 mt-2 border-t border-green-400';
                     completeMsg.innerHTML = '<p class="text-sm font-bold text-green-700">✨ Tour Complete! Enjoy your stay.</p>';
                     lastItem.appendChild(completeMsg);
                     
                     highlightSidebarStop(-1); // Clear sidebar highlight
                     highlightMapMarker(null); // Clear map highlight
                }
                return;
            }

            const nextStop = stops[currentStopIndex];
            const userLatLng = L.latLng(userLat, userLng);
            const stopLatLng = L.latLng(nextStop.lat, nextStop.lng);
            
            // Calculate distance in meters
            const distance = userLatLng.distanceTo(stopLatLng); 

            let distanceText;
            if (distance < 1000) {
                distanceText = `${Math.round(distance)} meters`;
            } else {
                distanceText = `${(distance / 1000).toFixed(2)} km`;
            }

            // --- Auto-Advance Logic (Within 50 meters) ---
            if (distance < 50) {
                showMessageModal("Stop Reached!", `You are within 50 meters of Stop ${nextStop.id}: ${nextStop.name}. Moving to the next stop.`);
                currentStopIndex++;
                
                // Recursively call to update the UI for the new target immediately
                updateGuidanceInSidebar(userLat, userLng);
                return;
            }

            // 3. Inject Guidance into the Target Sidebar Item
            const itemToUpdate = document.getElementById(`stop-${nextStop.id}`);
            if (itemToUpdate) {
                const guidanceDiv = document.createElement('div');
                guidanceDiv.className = 'guidance-info pt-1 mt-2 border-t border-red-300';
                guidanceDiv.innerHTML = `
                    <p class="text-xs font-medium text-gray-500 uppercase">Current Target:</p>
                    <p class="text-sm font-bold text-red-700">Distance: ${distanceText}</p>
                `;
                
                itemToUpdate.appendChild(guidanceDiv);
            }
            
            // 4. Highlight the current target stop in the sidebar AND on the map
            highlightSidebarStop(nextStop.id);
            highlightMapMarker(nextStop.id);
        }

        /**
         * Highlights the target stop in the sidebar and scrolls to it.
         */
        function highlightSidebarStop(id) {
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('bg-red-100', 'border-red-600');
            });
            const itemToHighlight = document.getElementById(`stop-${id}`);
            if (itemToHighlight) {
                 itemToHighlight.classList.add('bg-red-100', 'border-red-600');
                 // Scroll the sidebar to the highlighted item
                 itemToHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }


        /**
         * Initializes the Leaflet map centered on the starting point of the tour.
         */
        function initMap() {
            const startCoords = [stops[0].lat, stops[0].lng];

            // 1. Initialize the map
            map = L.map('map', {
                center: startCoords,
                zoom: 16,
                zoomControl: false 
            });

            // 2. Add Tile Layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // 3. Add Custom Zoom Control
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // 4. Attach event listeners
            document.getElementById('locate-button').addEventListener('click', toggleLocationTracking);
            
            document.getElementById('modal-close-button').addEventListener('click', () => {
                document.getElementById('message-modal').classList.remove('flex');
                document.getElementById('message-modal').classList.add('hidden');
            });
        }
        
        function onLocationFound(e) {
            const radius = e.coords.accuracy;
            const latlng = [e.coords.latitude, e.coords.longitude];

            // Update the map marker and accuracy circle
            if (locationMarker) {
                locationMarker.setLatLng(latlng);
            } else {
                locationMarker = L.circleMarker(latlng, {
                    radius: 8,
                    color: '#1D4ED8',
                    fillColor: '#3B82F6',
                    fillOpacity: 1,
                    stroke: true
                }).addTo(map)
                .bindPopup(`You are here (Accuracy: ${Math.round(radius)} m)`).openPopup();
            }

            if (accuracyCircle) {
                accuracyCircle.setLatLng(latlng);
                accuracyCircle.setRadius(radius);
            } else {
                accuracyCircle = L.circle(latlng, radius, {
                    color: '#3B82F6',
                    fillColor: '#60A5FA',
                    fillOpacity: 0.2,
                    weight: 2,
                    opacity: 0.5
                }).addTo(map);
            }

            if (map.isUserLocating) {
                 // Only pan/zoom when tracking is first started
                 map.flyTo(latlng, Math.min(17, map.getZoom()), { duration: 1.5 });
                 map.isUserLocating = false;
            }
            
            // Update the sidebar guidance with real-time data.
            updateGuidanceInSidebar(e.coords.latitude, e.coords.longitude);
        }

        function onLocationError(e) {
            let errorMessage = "Could not retrieve location.";
            if (e.code === 1) {
                errorMessage = "Location access denied. Please allow location services for this page.";
            } else if (e.code === 3) {
                 errorMessage = "Location timeout. Please ensure you have a clear GPS signal.";
            }
            showMessageModal("Location Error", errorMessage);
            console.error(e);
            stopLocationTracking();
        }

        function startLocationTracking() {
            if (!("geolocation" in navigator)) {
                showMessageModal("Location Not Supported", "Geolocation is not supported by your browser.");
                return;
            }
            
            map.isUserLocating = true; 
            currentStopIndex = 1; // Always start tracking from Stop 2 (index 1)
            
            locateWatchId = navigator.geolocation.watchPosition(onLocationFound, onLocationError, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            });
            
            document.getElementById('locate-button').classList.add('text-red-600', 'font-bold');
            showMessageModal("Location Started", "Tracking your position! The next stop is now highlighted on the map and in the sidebar.");
        }
        
        function stopLocationTracking() {
            if (locateWatchId !== null) {
                navigator.geolocation.clearWatch(locateWatchId);
                locateWatchId = null;
            }
            if (locationMarker) {
                map.removeLayer(locationMarker);
                locationMarker = null;
            }
            if (accuracyCircle) {
                map.removeLayer(accuracyCircle);
                accuracyCircle = null;
            }
            
            highlightMapMarker(null); // Clear map highlight
            
            // Clear all injected guidance text when tracking stops
            document.querySelectorAll('.guidance-info').forEach(el => el.remove());

            document.getElementById('locate-button').classList.remove('text-red-600', 'font-bold');
            
            // Remove all sidebar highlights
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('bg-red-100', 'border-red-600');
            });
            showMessageModal("Location Stopped", "Location tracking has been turned off.");
        }

        function toggleLocationTracking() {
            if (locateWatchId === null) {
                startLocationTracking();
            } else {
                stopLocationTracking();
            }
        }


        /**
         * Adds markers, draws the polyline line, and populates the sidebar.
         */
        function addStopsToMapAndSidebar() {
            const stopsList = document.getElementById('stops-list');

            stops.forEach(stop => {
                const coords = [stop.lat, stop.lng];
                
                // --- 1. Create Custom Marker Icon (Default Red) ---
                const defaultIcon = L.divIcon({
                    ...defaultIconOptions,
                    html: `<div>${stop.id}</div>`,
                });

                // --- 2. Create Marker and Add to Map ---
                const marker = L.marker(coords, { 
                    icon: defaultIcon
                }).addTo(map);

                // Store marker reference
                allMarkers.push({ id: stop.id, marker: marker }); 

                // --- 3. Add Popup Content ---
                const popupContent = `
                    <div class="font-bold text-red-600 text-lg mb-1">STOP ${stop.id}: ${stop.name}</div>
                    <p class="text-gray-700 text-sm">${stop.description}</p>
                `;
                marker.bindPopup(popupContent, {
                    offset: L.point(0, -10)
                });
                
                // Add click listener to marker
                marker.on('click', () => {
                    handleStopClick(stop.id, marker);
                });


                // --- 4. Create Sidebar Item ---
                const listItem = document.createElement('div');
                listItem.id = `stop-${stop.id}`;
                // Note: The `pb-3` padding here is default. It is dynamically adjusted via CSS when highlighted
                listItem.className = 'sidebar-item p-3 border border-gray-200 rounded-lg cursor-pointer transition-all hover:border-red-400';
                listItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="tour-marker bg-red-500">${stop.id}</div>
                        <div class="flex-grow">
                            <h3 class="text-base font-semibold text-gray-800">${stop.name}</h3>
                            <p class="text-xs text-gray-500 truncate">${stop.description}</p>
                        </div>
                    </div>
                `;

                // Add click listener to sidebar item
                listItem.addEventListener('click', () => {
                    handleStopClick(stop.id, marker);
                });

                stopsList.appendChild(listItem);
            });


            // --- 5. Draw the MANUAL Polyline connecting all points ---
            L.polyline(detailedCoords, {
                className: 'tour-path' 
            }).addTo(map);


            // Fit map bounds to encompass all points
            const mainStopCoords = stops.map(stop => [stop.lat, stop.lng]);
            const bounds = L.latLngBounds(mainStopCoords);
            map.fitBounds(bounds, { padding: [50, 50] });


            // Helper function to handle clicks (from map marker or sidebar)
            function handleStopClick(id, marker) {
                // Pan map to the marker location
                map.flyTo(marker.getLatLng(), 17, { duration: 1.0 });

                // Open the marker's popup
                marker.openPopup();
                
                // Optional: When clicking on a stop, update the currentStopIndex 
                if (id < stops.length) {
                    currentStopIndex = id; // id is 1-indexed, index is 0-indexed
                    if (locateWatchId !== null) {
                         showMessageModal("Navigation Updated", `Now navigating toward STOP ${currentStopIndex + 1}.`);
                         // Update the map marker and guidance immediately if tracking is active
                         updateGuidanceInSidebar(map.getCenter().lat, map.getCenter().lng);
                    }
                }

                // Highlight the stop in the sidebar
                highlightSidebarStop(id);
            }
        }
        
        /**
         * Implements active polling to ensure Leaflet (L) is fully loaded.
         */
        function checkLeafletReady() {
            if (typeof L !== 'undefined' && L.map) {
                try {
                    initMap();
                    addStopsToMapAndSidebar();
                } catch (error) {
                    console.error("Map initialization failed:", error);
                }
            } else {
                setTimeout(checkLeafletReady, 10);
            }
        }

        checkLeafletReady();

    </script>
</body>
</html>
